name: iOS Build (Debug)

on:
  workflow_dispatch:  # 수동 실행 가능

jobs:
  ios-build:
    runs-on: macos-latest
    
    steps:
    - name: 📥 코드 체크아웃
      uses: actions/checkout@v4
      
    - name: 🔧 Node.js 설정
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'yarn'
        cache-dependency-path: mobile/yarn.lock
        
    - name: 📦 의존성 설치
      working-directory: mobile
      run: yarn install --frozen-lockfile
        
    - name: ⚙️ 환경 설정
      working-directory: mobile
      run: |
        echo "APP_ENV=staging" > .env
        echo "API_BASE_URL=https://api.example.com" >> .env
        echo "TIMEOUT=15000" >> .env
        echo "DEBUG_MODE=true" >> .env
        echo "📄 환경 파일 내용:"
        cat .env
        
    - name: 🍎 CocoaPods 설치
      working-directory: mobile
      run: npx pod-install ios
        
    - name: 🏗️ iOS 빌드 (디버그 모드)
      working-directory: mobile
      run: |
        echo "🔍 Xcode 버전 확인:"
        xcodebuild -version
        
        echo "📂 프로젝트 구조 확인:"
        ls -la ios/
        
        echo "🏗️ iOS 빌드 시작 (Debug 모드):"
        xcodebuild -workspace ios/mobile.xcworkspace \
          -scheme mobile \
          -configuration Debug \
          -sdk iphonesimulator \
          -derivedDataPath ios/build \
          build
          
    - name: 📦 빌드 결과 확인
      working-directory: mobile
      run: |
        echo "📂 빌드 결과 확인:"
        find ios/build -name "*.app" -type d
        ls -la ios/build/Build/Products/Debug-iphonesimulator/ || true
        
        if [ -d "ios/build/Build/Products/Debug-iphonesimulator/mobile.app" ]; then
          echo "✅ mobile.app 발견!"
          ls -la ios/build/Build/Products/Debug-iphonesimulator/mobile.app/
        else
          echo "❌ mobile.app을 찾을 수 없습니다"
          echo "📂 전체 빌드 디렉터리 구조:"
          find ios/build -type d -name "*.app" || true
        fi