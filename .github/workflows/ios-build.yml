name: iOS Build (Fixed v2)

on:
  workflow_dispatch:

jobs:
  ios-build:
    runs-on: macos-latest
    
    steps:
    - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'yarn'
        cache-dependency-path: mobile/yarn.lock
        
    - name: ðŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      working-directory: mobile
      run: yarn install --frozen-lockfile
        
    - name: âš™ï¸ í™˜ê²½ ì„¤ì •
      working-directory: mobile
      run: |
        echo "APP_ENV=staging" > .env
        echo "API_BASE_URL=https://api.example.com" >> .env
        echo "TIMEOUT=15000" >> .env
        echo "DEBUG_MODE=true" >> .env
        echo "ðŸ“„ í™˜ê²½ íŒŒì¼ ìƒì„± ì™„ë£Œ:"
        cat .env
        
    - name: ðŸ§¹ iOS ìºì‹œ ì™„ì „ ì •ë¦¬
      working-directory: mobile
      run: |
        echo "ðŸ—‘ï¸ ê¸°ì¡´ ë¹Œë“œ íŒŒì¼ ì •ë¦¬..."
        rm -rf ios/build
        rm -rf ios/Pods
        rm -rf ios/Podfile.lock
        rm -rf ~/Library/Caches/CocoaPods
        rm -rf ~/Library/Developer/Xcode/DerivedData
        echo "âœ… ìºì‹œ ì •ë¦¬ ì™„ë£Œ"
        
    - name: ðŸŽ CocoaPods ìž¬ì„¤ì¹˜
      working-directory: mobile
      run: |
        echo "ðŸ“¦ CocoaPods ë²„ì „ í™•ì¸:"
        pod --version
        
        echo "ðŸ”„ CocoaPods ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
        cd ios
        pod install --repo-update --clean-install --verbose
        
    - name: ðŸ—ï¸ iOS ë¹Œë“œ (Debug)
      working-directory: mobile
      run: |
        echo "ðŸ” Xcode ë²„ì „:"
        xcodebuild -version
        
        echo "ðŸ“± ì‚¬ìš© ê°€ëŠ¥í•œ ì‹œë®¬ë ˆì´í„°:"
        xcrun simctl list devices available
        
        echo "ðŸ—ï¸ iOS ì•± ë¹Œë“œ ì‹œìž‘..."
        xcodebuild -workspace ios/mobile.xcworkspace \
          -scheme mobile \
          -configuration Debug \
          -sdk iphonesimulator \
          -derivedDataPath ios/build \
          -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' \
          clean build \
          | xcpretty || true
          
    - name: ðŸ“¦ ë¹Œë“œ ê²°ê³¼ í™•ì¸
      working-directory: mobile
      run: |
        echo "ðŸ“‚ ë¹Œë“œ ë””ë ‰í„°ë¦¬ êµ¬ì¡°:"
        find ios/build -name "*.app" -type d 2>/dev/null || echo "âŒ .app íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
        
        APP_PATH="ios/build/Build/Products/Debug-iphonesimulator/mobile.app"
        if [ -d "$APP_PATH" ]; then
          echo "âœ… iOS ë¹Œë“œ ì„±ê³µ!"
          echo "ðŸ“ ì•± í¬ê¸°: $(du -sh "$APP_PATH" | cut -f1)"
          echo "ðŸ“„ ì•± ë‚´ìš©:"
          ls -la "$APP_PATH"
        else
          echo "âŒ ë¹Œë“œ ì‹¤íŒ¨ - mobile.appì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          echo "ðŸ“‚ Debug-iphonesimulator ë””ë ‰í„°ë¦¬ ë‚´ìš©:"
          ls -la ios/build/Build/Products/Debug-iphonesimulator/ 2>/dev/null || echo "ë””ë ‰í„°ë¦¬ê°€ ì¡´ìž¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"
          exit 1
        fi