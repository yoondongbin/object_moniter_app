name: iOS Build

on:
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  ios-build:
    runs-on: macos-latest
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'yarn'
        cache-dependency-path: mobile/yarn.lock
        
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      working-directory: mobile
      run: yarn install --frozen-lockfile
        
    - name: âš™ï¸ í™˜ê²½ ì„¤ì •
      working-directory: mobile
      env:
        APP_ENV: staging
        API_BASE_URL: https://api.example.com
        BUILD_NUMBER: ${{ github.run_number }}
      run: ./scripts/ci-make-env.sh
        
    - name: ğŸ CocoaPods ì„¤ì¹˜
      working-directory: mobile
      run: npx pod-install ios
        
    - name: ğŸ—ï¸ iOS ë¹Œë“œ
      working-directory: mobile
      run: |
        xcodebuild -workspace ios/mobile.xcworkspace \
          -scheme mobile \
          -configuration Release \
          -sdk iphonesimulator \
          -derivedDataPath ios/build \
          clean build
          
    - name: ğŸ“¦ ì•± ì••ì¶•
      working-directory: mobile
      run: |
        cd ios/build/Build/Products/Release-iphonesimulator
        if [ -d "mobile.app" ]; then
          zip -r mobile-staging-${{ github.run_number }}.app.zip mobile.app
          echo "âœ… iOS ì•± ë¹Œë“œ ë° ì••ì¶• ì™„ë£Œ"
        else
          echo "âŒ mobile.appì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          exit 1
        fi
        
    - name: ğŸ“¤ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: ios-app-staging-${{ github.run_number }}
        path: mobile/ios/build/Build/Products/Release-iphonesimulator/*.zip
        retention-days: 30