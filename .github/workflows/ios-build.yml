name: iOS Build (iOS 15.1)

on:
  workflow_dispatch:

jobs:
  ios-build:
    runs-on: macos-latest
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'yarn'
        cache-dependency-path: mobile/yarn.lock
        
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      working-directory: mobile
      run: yarn install --frozen-lockfile
        
    - name: âš™ï¸ í™˜ê²½ ì„¤ì •
      working-directory: mobile
      run: |
        echo "APP_ENV=staging" > .env
        echo "API_BASE_URL=https://api.example.com" >> .env
        echo "TIMEOUT=15000" >> .env
        echo "DEBUG_MODE=true" >> .env
        echo "ğŸ“„ í™˜ê²½ íŒŒì¼ ìƒì„± ì™„ë£Œ:"
        cat .env
        
    - name: ğŸ§¹ iOS ìºì‹œ ì™„ì „ ì •ë¦¬
      working-directory: mobile
      run: |
        echo "ğŸ—‘ï¸ ê¸°ì¡´ ë¹Œë“œ íŒŒì¼ ì •ë¦¬..."
        rm -rf ios/build
        rm -rf ios/Pods
        rm -rf ios/Podfile.lock
        rm -rf ~/Library/Caches/CocoaPods
        rm -rf ~/Library/Developer/Xcode/DerivedData
        echo "âœ… ìºì‹œ ì •ë¦¬ ì™„ë£Œ"
        
    - name: ğŸ CocoaPods ì¬ì„¤ì¹˜ (iOS 15.1)
      working-directory: mobile
      run: |
        echo "ğŸ“¦ CocoaPods ë²„ì „ í™•ì¸:"
        pod --version
        
        echo "ğŸ”§ iOS ë°°í¬ íƒ€ê²Ÿ: 15.1 (React Native 0.80.2 ì •í™•í•œ ìš”êµ¬ì‚¬í•­)"
        echo "ğŸ”„ CocoaPods ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
        cd ios
        
        # ë” ì•ˆì •ì ì¸ ì„¤ì¹˜ë¥¼ ìœ„í•œ ì˜µì…˜ (ë°°í¬ ëª¨ë“œ ë¹„í™œì„±í™”: Podfile ë³€ê²½ì‚¬í•­ ë°˜ì˜)
        pod install --repo-update --clean-install --verbose
        
    - name: ğŸ—ï¸ iOS ë¹Œë“œ (Release - iOS 15.1+)
      working-directory: mobile
      run: |
        set -euo pipefail
        echo "ğŸ” Xcode ë²„ì „:"
        xcodebuild -version

        echo "ğŸ“± ì‚¬ìš© ê°€ëŠ¥í•œ ì‹œë®¬ë ˆì´í„° (ìƒìœ„ 10ê°œ):"
        xcrun simctl list devices available | grep -E "(iPhone|iPad)" | head -10 || true

        echo "ğŸ—ï¸ iOS ì•± ë¹Œë“œ ì‹œì‘ (Release)..."
        # ìš°ì„  generic ëŒ€ìƒ ì‹œë„, ì‹¤íŒ¨ ì‹œ ì²« ë²ˆì§¸ ì‚¬ìš© ê°€ëŠ¥í•œ iPhone ì‹œë®¬ë ˆì´í„° ì´ë¦„ìœ¼ë¡œ ì¬ì‹œë„
        DEST_GENERIC="generic/platform=iOS Simulator"
        FIRST_IPHONE_NAME=$(xcrun simctl list devices available | awk '/^\s+iPhone/{print substr($0, index($0,$2)); exit}' | sed -E 's/ \(.+//') || true
        DEST_BY_NAME="platform=iOS Simulator,name=${FIRST_IPHONE_NAME}"

        echo "ğŸ” 1ì°¨ ëŒ€ìƒ: ${DEST_GENERIC}"
        set +e
        xcodebuild -workspace ios/mobile.xcworkspace \
          -scheme mobile \
          -configuration Release \
          -sdk iphonesimulator \
          -derivedDataPath ios/build \
          -destination "${DEST_GENERIC}" \
          IPHONEOS_DEPLOYMENT_TARGET=15.1 \
          clean build | xcpretty
        XC_STATUS=$?
        set -e

        if [ ${XC_STATUS} -ne 0 ]; then
          echo "âš ï¸ generic ëŒ€ìƒ ì‹¤íŒ¨ â†’ ì´ë¦„ ê¸°ë°˜ ëŒ€ìƒ ì¬ì‹œë„: ${DEST_BY_NAME}"
          xcodebuild -workspace ios/mobile.xcworkspace \
            -scheme mobile \
            -configuration Release \
            -sdk iphonesimulator \
            -derivedDataPath ios/build \
            -destination "${DEST_BY_NAME}" \
            IPHONEOS_DEPLOYMENT_TARGET=15.1 \
            clean build | xcpretty
        fi
          
    - name: ğŸ“¦ ë¹Œë“œ ê²°ê³¼ í™•ì¸
      working-directory: mobile
      run: |
        echo "ğŸ“‚ ë¹Œë“œ ê²°ê³¼ì—ì„œ .app ê²€ìƒ‰:"
        APP_PATH=$(find ios/build/Build/Products -type d -name "*.app" | head -1 || true)
        if [ -n "$APP_PATH" ] && [ -d "$APP_PATH" ]; then
          echo "âœ… iOS ë¹Œë“œ ì„±ê³µ! (iOS 15.1+ ì§€ì›)"
          echo "ğŸ“„ APP_PATH: $APP_PATH"
          echo "ğŸ“ ì•± í¬ê¸°: $(du -sh "$APP_PATH" | cut -f1)"
          echo "ğŸ“„ ì•± ë‚´ìš©:"
          ls -la "$APP_PATH" | head -10
          
          # Info.plistì—ì„œ ìµœì†Œ iOS ë²„ì „ í™•ì¸
          if [ -f "$APP_PATH/Info.plist" ]; then
            echo "ğŸ“‹ MinimumOSVersion: $(/usr/libexec/PlistBuddy -c 'Print :MinimumOSVersion' "$APP_PATH/Info.plist" 2>/dev/null || echo 'N/A')"
          fi
        else
          echo "âŒ mobile.appì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¹Œë“œ ë¡œê·¸ ìƒë‹¨ ë‹¨ê³„ë¥¼ í™•ì¸í•˜ì„¸ìš”."
          echo "ğŸ“‚ Products ë””ë ‰í„°ë¦¬ êµ¬ì¡°:"
          find ios/build/Build/Products -maxdepth 3 -type d -print || true
          exit 1
        fi
        
    - name: ğŸ“¤ ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (ì„ íƒì‚¬í•­)
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: ios-app-release-${{ github.run_number }}
        path: mobile/ios/build/Build/Products/**/*.app
        retention-days: 7