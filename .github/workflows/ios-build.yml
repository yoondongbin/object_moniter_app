name: iOS Build (iOS 15.1+)

on:
  workflow_dispatch:

jobs:
  ios-build:
    # âœ… ì•ˆì •ì ì¸ macos-14ë¡œ ë³€ê²½ (Xcode 15.x + iOS 17.x ëŸ°íƒ€ì„ ë³´ìœ )
    runs-on: macos-14

    env:
      APP_WORKSPACE: ios/mobile.xcworkspace
      APP_SCHEME: mobile
      DERIVED_DATA: mobile/ios/build
      IOS_MIN_TARGET: "15.1"
      PREFERRED_DEVICE_1: "iPhone 15"
      PREFERRED_DEVICE_2: "iPhone 14"
      PREFERRED_DEVICE_3: "iPhone 13"
      # âœ… macos-14ì— ì‹¤ì œ ì¡´ì¬í•˜ëŠ” ëŸ°íƒ€ì„ìœ¼ë¡œ ë³€ê²½
      PREFERRED_RUNTIME_1: "iOS 17.5"
      PREFERRED_RUNTIME_2: "iOS 17.4"

    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ”§ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'
          cache-dependency-path: mobile/yarn.lock

      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        working-directory: mobile
        run: yarn install --frozen-lockfile

      - name: âš™ï¸ í™˜ê²½ ì„¤ì •(.env ìƒì„±)
        working-directory: mobile
        run: |
          set -euo pipefail
          echo "APP_ENV=staging" > .env
          echo "API_BASE_URL=https://api.example.com" >> .env
          echo "TIMEOUT=15000" >> .env
          echo "DEBUG_MODE=true" >> .env
          echo "ğŸ“„ ìƒì„±ëœ .env ë‚´ìš© â†“"
          cat .env

      - name: ğŸ§¹ iOS ìºì‹œ ì™„ì „ ì •ë¦¬
        working-directory: mobile
        run: |
          set -euo pipefail
          echo "ğŸ—‘ï¸ ê¸°ì¡´ ë¹Œë“œ/íŒŒë“œ/íŒŒìƒ ë°ì´í„° ì‚­ì œ"
          rm -rf ios/build ios/Pods ios/Podfile.lock
          rm -rf ~/Library/Caches/CocoaPods ~/Library/Developer/Xcode/DerivedData
          echo "âœ… ìºì‹œ ì •ë¦¬ ì™„ë£Œ"

      - name: ğŸ CocoaPods ì„¤ì¹˜/ë™ê¸°í™”
        working-directory: mobile/ios
        run: |
          set -euo pipefail
          echo "ğŸ“¦ CocoaPods ë²„ì „ í™•ì¸:"
          pod --version
          echo "ğŸ”„ pod install ì‹¤í–‰"
          pod install --repo-update --clean-install --verbose

      - name: ğŸ§© Xcode/ëŸ°íƒ€ì„ ì ê²€
        run: |
          set -euo pipefail
          echo "ğŸ” Xcode ê²½ë¡œ: $(xcode-select -p)"
          xcodebuild -version
          echo "ğŸ“š ì„¤ì¹˜ëœ ëŸ°íƒ€ì„ ëª©ë¡:"
          xcrun simctl list runtimes
          echo "ğŸ“± ì‚¬ìš©ê°€ëŠ¥ ë””ë°”ì´ìŠ¤(available):"
          xcrun simctl list devices available

      # âœ… ë” ê°„ë‹¨í•˜ê³  ì•ˆì •ì ì¸ ë°©ì‹ìœ¼ë¡œ ë³€ê²½
      - name: ğŸ§ª iOS ì‹œë®¬ë ˆì´í„° ìƒì„± ë° ë¶€íŒ… (ìˆ˜ì •ëœ ëŸ°íƒ€ì„ ID)
        id: boot-sim
        run: |
          set -euo pipefail

          echo "ğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ ëŸ°íƒ€ì„ í™•ì¸:"
          xcrun simctl list runtimes

          # âœ… ì˜¬ë°”ë¥¸ ëŸ°íƒ€ì„ ID ì¶”ì¶œ (com.apple.CoreSimulator.SimRuntime.iOS-17-0 í˜•ì‹)
          RUNTIME_ID=$(xcrun simctl list runtimes | grep "iOS" | head -1 | grep -o 'com\.apple\.CoreSimulator\.SimRuntime\.iOS-[0-9-]*')
          
          if [ -z "${RUNTIME_ID:-}" ]; then
            echo "âŒ ì‚¬ìš©í•  iOS ëŸ°íƒ€ì„ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."
            echo "ğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ ëŸ°íƒ€ì„ ëª©ë¡:"
            xcrun simctl list runtimes
            exit 1
          fi
          echo "âœ… ì„ íƒëœ ëŸ°íƒ€ì„ ID: ${RUNTIME_ID}"

          # iPhone 15 ë˜ëŠ” ì‚¬ìš© ê°€ëŠ¥í•œ ì²« ë²ˆì§¸ iPhone ì„ íƒ
          DEVICE_TYPE="iPhone 15"
          if ! xcrun simctl list devicetypes | grep -q "iPhone 15"; then
            DEVICE_TYPE=$(xcrun simctl list devicetypes | grep "iPhone" | head -1 | awk -F ' \\(' '{print $1}')
          fi
          echo "âœ… ì„ íƒëœ ë””ë°”ì´ìŠ¤: ${DEVICE_TYPE}"

          # ì‹œë®¬ë ˆì´í„° ìƒì„± ë° ë¶€íŒ…
          echo "ğŸ”¨ ì‹œë®¬ë ˆì´í„° ìƒì„± ì¤‘..."
          UDID=$(xcrun simctl create "CI-iOS-Build" "$DEVICE_TYPE" "$RUNTIME_ID")
          echo "ğŸ†” ìƒì„±ëœ UDID: $UDID"

          echo "ğŸš€ ì‹œë®¬ë ˆì´í„° ë¶€íŒ… ì¤‘..."
          xcrun simctl boot "$UDID"
          xcrun simctl bootstatus "$UDID" -b

          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV

      - name: ğŸ§´ xcpretty ì„¤ì¹˜(ì˜µì…˜)
        run: |
          set -euo pipefail
          sudo gem install xcpretty || true

      - name: ğŸ—ï¸ iOS ë¹Œë“œ (Release, Simulator)
        working-directory: mobile
        run: |
          set -euo pipefail
          echo "ğŸ”¨ ë¹Œë“œ ì‹œì‘â€¦"
          xcodebuild \
            -workspace "$APP_WORKSPACE" \
            -scheme "$APP_SCHEME" \
            -configuration Release \
            -sdk iphonesimulator \
            -derivedDataPath "$DERIVED_DATA" \
            -destination "platform=iOS Simulator,id=$SIMULATOR_UDID" \
            IPHONEOS_DEPLOYMENT_TARGET="$IOS_MIN_TARGET" \
            CODE_SIGNING_ALLOWED=NO CODE_SIGNING_REQUIRED=NO \
            clean build | xcpretty || true

      - name: ğŸ“¦ ë¹Œë“œ ê²°ê³¼ í™•ì¸
        working-directory: mobile
        run: |
          set -euo pipefail
          echo "ğŸ“‚ .app ê²€ìƒ‰:"
          APP_PATH=$(find "$DERIVED_DATA/Build/Products" -type d -name "*.app" | head -1 || true)
          if [ -n "${APP_PATH:-}" ] && [ -d "$APP_PATH" ]; then
            echo "âœ… iOS ë¹Œë“œ ì„±ê³µ"
            echo "APP_PATH: $APP_PATH"
            du -sh "$APP_PATH" || true
            ls -la "$APP_PATH" | head -20 || true
            if [ -f "$APP_PATH/Info.plist" ]; then
              echo "ğŸ“‹ MinimumOSVersion:"
              /usr/libexec/PlistBuddy -c 'Print :MinimumOSVersion' "$APP_PATH/Info.plist" || echo "N/A"
            fi
          else
            echo "âŒ .appì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ìœ„ ë¹Œë“œ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."
            echo "ğŸ“‚ Products ë””ë ‰í„°ë¦¬ êµ¬ì¡°:"
            find "$DERIVED_DATA/Build/Products" -maxdepth 3 -type d -print || true
            exit 1
          fi

      - name: â¬†ï¸ ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (ì„ íƒ)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ios-app-release-${{ github.run_number }}
          path: mobile/ios/build/Build/Products/**/*.app
          retention-days: 7

      - name: ğŸ§½ ì‹œë®¬ë ˆì´í„° ì •ë¦¬
        if: always()
        run: |
          set -euo pipefail
          if [ -n "${SIMULATOR_UDID:-}" ]; then
            echo "ğŸ§¹ ì‹œë®¬ë ˆì´í„° ì‚­ì œ: $SIMULATOR_UDID"
            xcrun simctl shutdown "$SIMULATOR_UDID" || true
            xcrun simctl delete "$SIMULATOR_UDID" || true
          fi
