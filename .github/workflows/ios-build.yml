name: iOS Build (iOS 15.1+)

on:
  workflow_dispatch:

jobs:
  ios-build:
    # âœ… ëŸ¬ë„ˆ ì´ë¯¸ì§€ ê³ ì • (Xcode 16 í¬í•¨). latest ì‚¬ìš© ì‹œ ëŸ°íƒ€ì„ í¸ì°¨ë¡œ ì‹¤íŒ¨í•  ìˆ˜ ìˆìŒ
    runs-on: macos-15

    env:
      # â–¶ í”„ë¡œì íŠ¸/ìŠ¤í‚´ ê´€ë ¨ ê³µí†µ ë³€ìˆ˜(í•„ìš” ì‹œ í•œ ê³³ë§Œ ìˆ˜ì •)
      APP_WORKSPACE: ios/mobile.xcworkspace        # Xcode ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ê²½ë¡œ
      APP_SCHEME: mobile                           # Shared ì²´í¬ëœ ìŠ¤í‚´ëª…
      DERIVED_DATA: mobile/ios/build               # íŒŒìƒ ë°ì´í„° ê²½ë¡œ
      IOS_MIN_TARGET: "15.1"                       # iOS ìµœì†Œ ì§€ì› ë²„ì „(í”„ë¡œì íŠ¸ì™€ ì¼ì¹˜)
      # â–¶ ìƒì„±í•  ì‹œë®¬ë ˆì´í„° ì„ í˜¸ ìˆœì„œ(ê¸°ê¸°/ëŸ°íƒ€ì„ í´ë°± í¬í•¨)
      PREFERRED_DEVICE_1: "iPhone 16"
      PREFERRED_DEVICE_2: "iPhone 15"
      PREFERRED_DEVICE_3: "iPhone 14"
      PREFERRED_RUNTIME_1: "iOS 18.0"
      PREFERRED_RUNTIME_2: "iOS 17.5"

    steps:
      # 1) ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      # 2) Node ì„¤ì • + Yarn ìºì‹œ
      - name: ğŸ”§ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'
          cache-dependency-path: mobile/yarn.lock

      # 3) ì˜ì¡´ì„± ì„¤ì¹˜
      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        working-directory: mobile
        run: yarn install --frozen-lockfile

      # 4) .env ìƒì„± (í•„ìš” ì‹œ ìˆ˜ì •)
      - name: âš™ï¸ í™˜ê²½ ì„¤ì •(.env ìƒì„±)
        working-directory: mobile
        run: |
          set -euo pipefail
          echo "APP_ENV=staging" > .env
          echo "API_BASE_URL=https://api.example.com" >> .env
          echo "TIMEOUT=15000" >> .env
          echo "DEBUG_MODE=true" >> .env
          echo "ğŸ“„ ìƒì„±ëœ .env ë‚´ìš© â†“"
          cat .env

      # 5) iOS ë¹Œë“œ ìºì‹œ ì •ë¦¬(ê¹¨ë—í•œ ìƒíƒœ ë³´ì¥)
      - name: ğŸ§¹ iOS ìºì‹œ ì™„ì „ ì •ë¦¬
        working-directory: mobile
        run: |
          set -euo pipefail
          echo "ğŸ—‘ï¸ ê¸°ì¡´ ë¹Œë“œ/íŒŒë“œ/íŒŒìƒ ë°ì´í„° ì‚­ì œ"
          rm -rf ios/build ios/Pods ios/Podfile.lock
          rm -rf ~/Library/Caches/CocoaPods ~/Library/Developer/Xcode/DerivedData
          echo "âœ… ìºì‹œ ì •ë¦¬ ì™„ë£Œ"

      # 6) CocoaPods ì„¤ì¹˜
      - name: ğŸ CocoaPods ì„¤ì¹˜/ë™ê¸°í™”
        working-directory: mobile/ios
        run: |
          set -euo pipefail
          echo "ğŸ“¦ CocoaPods ë²„ì „ í™•ì¸:"
          pod --version
          # Podfile ì˜ platform :ios, '15.1' ê³¼ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸ í•„ìš”
          echo "ğŸ”„ pod install ì‹¤í–‰"
          pod install --repo-update --clean-install --verbose

      # 7) Xcode/ëŸ°íƒ€ì„ ê¸°ë³¸ ì •ë³´ ì¶œë ¥(ë””ë²„ê¹… ìš©)
      - name: ğŸ§© Xcode/ëŸ°íƒ€ì„ ì ê²€
        run: |
          set -euo pipefail
          echo "ğŸ” Xcode ê²½ë¡œ: $(xcode-select -p)"
          xcodebuild -version
          echo "ğŸ“š ì„¤ì¹˜ëœ ëŸ°íƒ€ì„ ëª©ë¡:"
          xcrun simctl list runtimes
          echo "ğŸ“± ì‚¬ìš©ê°€ëŠ¥ ë””ë°”ì´ìŠ¤(available):"
          xcrun simctl list devices available

      # 8) iOS ì‹œë®¬ë ˆì´í„° ìƒì„± ë° ë¶€íŒ…(UDID íšë“) â€” ëŸ°íƒ€ì„/ê¸°ê¸° í´ë°± í¬í•¨
      - name: ğŸ§ª iOS ì‹œë®¬ë ˆì´í„° ìƒì„± ë° ë¶€íŒ… (UDID ì§€ì •)
        id: boot-sim
        run: |
          set -euo pipefail

          # â–· ì„ í˜¸ ëŸ°íƒ€ì„(18.0 â†’ 17.5) ìˆœìœ¼ë¡œ íƒìƒ‰
          ì„ íƒ_ëŸ°íƒ€ì„_ID=""
          for RUNTIME in "$PREFERRED_RUNTIME_1" "$PREFERRED_RUNTIME_2"; do
            í›„ë³´=$(xcrun simctl list runtimes | awk -v r="$RUNTIME" -F '[()]' '$0 ~ r {print $2; exit}')
            if [ -n "${í›„ë³´:-}" ]; then
              ì„ íƒ_ëŸ°íƒ€ì„_ID="$í›„ë³´"
              break
            fi
          done

          if [ -z "${ì„ íƒ_ëŸ°íƒ€ì„_ID:-}" ]; then
            echo "âŒ ì‚¬ìš©í•  iOS ì‹œë®¬ë ˆì´í„° ëŸ°íƒ€ì„ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."
            echo "   runs-on ì´ë¯¸ì§€ë¥¼ macos-15ë¡œ ê³ ì •í–ˆëŠ”ì§€, í˜¹ì€ ì´ë¯¸ì§€ì— iOS 18.0/17.5ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”."
            exit 1
          fi
          echo "âœ… ì„ íƒëœ ëŸ°íƒ€ì„: ${ì„ íƒ_ëŸ°íƒ€ì„_ID}"

          # â–· ì„ í˜¸ ê¸°ê¸°(16 â†’ 15 â†’ 14) ìˆœìœ¼ë¡œ ì¡´ì¬ í™•ì¸
          ì„ íƒ_ë””ë°”ì´ìŠ¤="$PREFERRED_DEVICE_1"
          if ! xcrun simctl list devicetypes | grep -q "^$PREFERRED_DEVICE_1 ("; then
            if xcrun simctl list devicetypes | grep -q "^$PREFERRED_DEVICE_2 ("; then
              ì„ íƒ_ë””ë°”ì´ìŠ¤="$PREFERRED_DEVICE_2"
            elif xcrun simctl list devicetypes | grep -q "^$PREFERRED_DEVICE_3 ("; then
              ì„ íƒ_ë””ë°”ì´ìŠ¤="$PREFERRED_DEVICE_3"
            else
              echo "âŒ ì‚¬ìš©í•  iPhone ë””ë°”ì´ìŠ¤ íƒ€ì…ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."
              xcrun simctl list devicetypes
              exit 1
            fi
          fi
          echo "âœ… ì„ íƒëœ ë””ë°”ì´ìŠ¤: ${ì„ íƒ_ë””ë°”ì´ìŠ¤}"

          # â–· ì‹œë®¬ë ˆì´í„° ìƒì„± â†’ ë¶€íŒ… â†’ ë¶€íŒ…ì™„ë£Œ ëŒ€ê¸°
          ìƒì„±_UDID=$(xcrun simctl create "CI-${ì„ íƒ_ë””ë°”ì´ìŠ¤// /}-Auto" "$ì„ íƒ_ë””ë°”ì´ìŠ¤" "$ì„ íƒ_ëŸ°íƒ€ì„_ID")
          echo "ğŸ†” ìƒì„±ëœ UDID: $ìƒì„±_UDID"

          xcrun simctl boot "$ìƒì„±_UDID"
          xcrun simctl bootstatus "$ìƒì„±_UDID" -b

          # â–· ì´í›„ ë‹¨ê³„ì—ì„œ ì‚¬ìš©í•  í™˜ê²½ë³€ìˆ˜ë¡œ ë“±ë¡
          echo "SIMULATOR_UDID=$ìƒì„±_UDID" >> $GITHUB_ENV

      # (ì˜µì…˜) xcpretty ì„¤ì¹˜ â€” ë¡œê·¸ ê°€ë…ì„± í–¥ìƒ. ì‹¤íŒ¨í•´ë„ ë¹Œë“œ ì§„í–‰
      - name: ğŸ§´ xcpretty ì„¤ì¹˜(ì˜µì…˜)
        run: |
          set -euo pipefail
          sudo gem install xcpretty || true

      # 9) iOS ë¹Œë“œ (ì‹œë®¬ë ˆì´í„°, Release) â€” UDIDë¡œ ëª…í™•íˆ íƒ€ê¹ƒ
      - name: ğŸ—ï¸ iOS ë¹Œë“œ (Release, Simulator)
        working-directory: mobile
        run: |
          set -euo pipefail
          echo "ğŸ”¨ ë¹Œë“œ ì‹œì‘â€¦"
          xcodebuild \
            -workspace "$APP_WORKSPACE" \
            -scheme "$APP_SCHEME" \
            -configuration Release \
            -sdk iphonesimulator \
            -derivedDataPath "$DERIVED_DATA" \
            -destination "platform=iOS Simulator,id=$SIMULATOR_UDID" \
            IPHONEOS_DEPLOYMENT_TARGET="$IOS_MIN_TARGET" \
            CODE_SIGNING_ALLOWED=NO CODE_SIGNING_REQUIRED=NO \
            clean build | xcpretty || true

      # 10) ë¹Œë“œ ê²°ê³¼ ê²€ì¦(.app ì¡´ì¬ ì—¬ë¶€ ë° MinOS í™•ì¸)
      - name: ğŸ“¦ ë¹Œë“œ ê²°ê³¼ í™•ì¸
        working-directory: mobile
        run: |
          set -euo pipefail
          echo "ğŸ“‚ .app ê²€ìƒ‰:"
          APP_PATH=$(find "$DERIVED_DATA/Build/Products" -type d -name "*.app" | head -1 || true)
          if [ -n "${APP_PATH:-}" ] && [ -d "$APP_PATH" ]; then
            echo "âœ… iOS ë¹Œë“œ ì„±ê³µ"
            echo "APP_PATH: $APP_PATH"
            du -sh "$APP_PATH" || true
            ls -la "$APP_PATH" | head -20 || true
            if [ -f "$APP_PATH/Info.plist" ]; then
              echo "ğŸ“‹ MinimumOSVersion:"
              /usr/libexec/PlistBuddy -c 'Print :MinimumOSVersion' "$APP_PATH/Info.plist" || echo "N/A"
            fi
          else
            echo "âŒ .appì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ìœ„ ë¹Œë“œ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."
            echo "ğŸ“‚ Products ë””ë ‰í„°ë¦¬ êµ¬ì¡°:"
            find "$DERIVED_DATA/Build/Products" -maxdepth 3 -type d -print || true
            exit 1
          fi

      # 11) ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ(ì„ íƒ)
      - name: â¬†ï¸ ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (ì„ íƒ)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ios-app-release-${{ github.run_number }}
          path: mobile/ios/build/Build/Products/**/*.app
          retention-days: 7

      # 12) (ì •ë¦¬) ìƒì„±í•œ ì‹œë®¬ë ˆì´í„° ì‚­ì œ â€” ëŸ¬ë„ˆ ìì› ë°˜í™˜
      - name: ğŸ§½ ì‹œë®¬ë ˆì´í„° ì •ë¦¬
        if: always()
        run: |
          set -euo pipefail
          if [ -n "${SIMULATOR_UDID:-}" ]; then
            echo "ğŸ§¹ ì‹œë®¬ë ˆì´í„° ì‚­ì œ: $SIMULATOR_UDID"
            xcrun simctl shutdown "$SIMULATOR_UDID" || true
            xcrun simctl delete "$SIMULATOR_UDID" || true
          fi
