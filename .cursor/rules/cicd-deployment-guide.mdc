---
globs: Jenkinsfile,deploy.sh,docker-compose*.yml,mobile/scripts/*.sh
description: CI/CD íŒŒì´í”„ë¼ì¸ ë° ë°°í¬ ìë™í™” ê°€ì´ë“œ
---

# CI/CD íŒŒì´í”„ë¼ì¸ ë° ë°°í¬ ìë™í™” ê°€ì´ë“œ

## ğŸš€ CI/CD ì•„í‚¤í…ì²˜ ê°œìš”

### íŒŒì´í”„ë¼ì¸ êµ¬ì„±
- **Jenkins**: ë¹Œë“œ ìë™í™” ë° ë°°í¬ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜
- **Docker**: ë°±ì—”ë“œ ì»¨í…Œì´ë„ˆí™” ë° ë°°í¬
- **Shell Scripts**: ëª¨ë°”ì¼ ì•± ë¹Œë“œ ìë™í™”
- **í™˜ê²½ ë¶„ë¦¬**: Development, Staging, Production

### ì£¼ìš” íŒŒì¼
- **íŒŒì´í”„ë¼ì¸ ì •ì˜**: [Jenkinsfile](mdc:Jenkinsfile)
- **Docker ì„¤ì •**: [docker-compose.yml](mdc:docker-compose.yml), [docker-compose.prod.yml](mdc:docker-compose.prod.yml)
- **ë°°í¬ ìŠ¤í¬ë¦½íŠ¸**: [deploy.sh](mdc:deploy.sh)
- **ëª¨ë°”ì¼ ë¹Œë“œ**: [mobile/scripts/](mdc:mobile/scripts/) ë””ë ‰í† ë¦¬

## ğŸ—ï¸ Jenkins íŒŒì´í”„ë¼ì¸ êµ¬ì¡°

### íŒŒë¼ë¯¸í„° ê¸°ë°˜ ë¹Œë“œ
```groovy
// Jenkinsfile - ë¹Œë“œ íŒŒë¼ë¯¸í„° ì •ì˜
parameters {
    choice(
        name: 'APP_ENV', 
        choices: ['development', 'staging', 'production'], 
        description: 'ğŸŒ ë¹Œë“œí•  í™˜ê²½ì„ ì„ íƒí•˜ì„¸ìš”'
    )
    booleanParam(name: 'BUILD_BACKEND', defaultValue: true, description: 'ğŸ³ ë°±ì—”ë“œ Docker ì´ë¯¸ì§€ ë¹Œë“œ')
    booleanParam(name: 'BUILD_ANDROID', defaultValue: true, description: 'ğŸ¤– Android APK ë¹Œë“œ')
    booleanParam(name: 'BUILD_IOS', defaultValue: true, description: 'ğŸ iOS ì•± ë¹Œë“œ')
    booleanParam(name: 'DEPLOY_BACKEND', defaultValue: false, description: 'ğŸš€ ë°±ì—”ë“œ ì„œë²„ì— ë°°í¬')
    booleanParam(name: 'CLEAN_BUILD', defaultValue: false, description: 'ğŸ§¹ ì™„ì „ í´ë¦° ë¹Œë“œ')
}
```

### ìŠ¤í…Œì´ì§€ë³„ ì‹¤í–‰ íë¦„
1. **í™˜ê²½ ì¤€ë¹„**: ë¹Œë“œ í™˜ê²½ ê²€ì¦ ë° ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
2. **ë°±ì—”ë“œ ë¹Œë“œ**: Docker ì´ë¯¸ì§€ ìƒì„± ë° ë ˆì§€ìŠ¤íŠ¸ë¦¬ í‘¸ì‹œ
3. **ëª¨ë°”ì¼ ì˜ì¡´ì„±**: Node.js íŒ¨í‚¤ì§€ ì„¤ì¹˜ ë° í™˜ê²½ ì„¤ì •
4. **Android ë¹Œë“œ**: Gradleì„ í†µí•œ APK ìƒì„±
5. **iOS ë¹Œë“œ**: Xcodeë¥¼ í†µí•œ ì•± ìƒì„± (macOS ì—ì´ì „íŠ¸ í•„ìš”)
6. **ë°°í¬**: ì„œë²„ì— Docker ì»¨í…Œì´ë„ˆ ë°°í¬

## ğŸ³ Docker ë°°í¬ íŒ¨í„´

### ê°œë°œ í™˜ê²½ (docker-compose.yml)
```yaml
# ë¡œì»¬ ê°œë°œìš© Docker Compose
version: '3.8'
services:
  backend:
    build: ./back_end
    ports:
      - "5010:5010"
    environment:
      - FLASK_ENV=development
      - MYSQL_HOST=db
    depends_on:
      - db
    volumes:
      - ./back_end/uploads:/app/uploads

  db:
    image: mariadb:10.6
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: object_monitor
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql

volumes:
  mysql_data:
```

### í”„ë¡œë•ì…˜ í™˜ê²½ (docker-compose.prod.yml)
```yaml
# í”„ë¡œë•ì…˜ìš© Docker Compose
version: '3.8'
services:
  backend:
    image: ${BACKEND_IMAGE:-object-monitor-backend:latest}
    restart: unless-stopped
    environment:
      - FLASK_ENV=production
      - MYSQL_HOST=db
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
    depends_on:
      - db
      - redis
    networks:
      - app-network

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - backend
    networks:
      - app-network

  db:
    image: mariadb:10.6
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - app-network

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    networks:
      - app-network

networks:
  app-network:
    driver: bridge

volumes:
  mysql_data:
```

## ğŸ“± ëª¨ë°”ì¼ ë¹Œë“œ ìë™í™”

### Android ë¹Œë“œ ìŠ¤í¬ë¦½íŠ¸ íŒ¨í„´
```bash
# mobile/scripts/build-release.sh - Android ë¦´ë¦¬ìŠ¤ ë¹Œë“œ
#!/bin/bash
set -e

ENV=${1:-staging}
echo "ğŸ¤– Android ${ENV} í™˜ê²½ ë¦´ë¦¬ìŠ¤ ë¹Œë“œ ì‹œì‘..."

# í™˜ê²½ ì„¤ì • ì ìš©
cp .env.${ENV} .env

# ì˜ì¡´ì„± ì„¤ì¹˜
yarn install --frozen-lockfile

# Android ë¹Œë“œ
cd android

# í‚¤ìŠ¤í† ì–´ ê²€ì¦
if [ ! -f "app/my-upload-key.keystore" ]; then
    echo "âŒ í”„ë¡œë•ì…˜ í‚¤ìŠ¤í† ì–´ê°€ ì—†ìŠµë‹ˆë‹¤!"
    exit 1
fi

# Gradle ë¹Œë“œ ì‹¤í–‰
./gradlew clean
./gradlew assembleRelease --no-daemon --stacktrace

# APK íŒŒì¼ í™•ì¸ ë° ì´ë¦„ ë³€ê²½
APK_PATH="app/build/outputs/apk/release/app-release.apk"
if [ -f "$APK_PATH" ]; then
    NEW_NAME="app-${ENV}-$(date +%Y%m%d-%H%M%S).apk"
    cp "$APK_PATH" "app/build/outputs/apk/release/$NEW_NAME"
    echo "âœ… APK ìƒì„± ì™„ë£Œ: $NEW_NAME"
else
    echo "âŒ APK ìƒì„± ì‹¤íŒ¨!"
    exit 1
fi
```

### iOS ë¹Œë“œ ìŠ¤í¬ë¦½íŠ¸ íŒ¨í„´
```bash
# mobile/scripts/build-ios.sh - iOS ë¹Œë“œ
#!/bin/bash
set -e

MODE=${1:-staging}
echo "ğŸ iOS ${MODE} í™˜ê²½ ë¹Œë“œ ì‹œì‘..."

# macOS í™˜ê²½ í™•ì¸
if [ "$(uname)" != "Darwin" ]; then
    echo "âŒ iOS ë¹Œë“œëŠ” macOSì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤!"
    exit 1
fi

# í™˜ê²½ ì„¤ì • ì ìš©
cp .env.${MODE} .env

# CocoaPods ì„¤ì¹˜
echo "ğŸ“¦ CocoaPods ì„¤ì¹˜ ì¤‘..."
npx pod-install ios

# Xcode ë¹Œë“œ
echo "ğŸ—ï¸ Xcode ë¹Œë“œ ì‹¤í–‰ ì¤‘..."
WORKSPACE="ios/mobile.xcworkspace"
SCHEME="mobile"

xcodebuild \
    -workspace "$WORKSPACE" \
    -scheme "$SCHEME" \
    -configuration Release \
    -sdk iphonesimulator \
    -derivedDataPath ios/build \
    clean build

# ë¹Œë“œ ê²°ê³¼ í™•ì¸
APP_PATH="ios/build/Build/Products/Release-iphonesimulator/mobile.app"
if [ -d "$APP_PATH" ]; then
    echo "âœ… iOS ì•± ë¹Œë“œ ì™„ë£Œ"
    
    # ì•± ì••ì¶•
    cd "$(dirname "$APP_PATH")"
    ZIP_NAME="mobile-${MODE}-$(date +%Y%m%d-%H%M%S).app.zip"
    zip -r "$ZIP_NAME" mobile.app
    echo "ğŸ“¦ ì•± ì••ì¶• ì™„ë£Œ: $ZIP_NAME"
else
    echo "âŒ iOS ì•± ë¹Œë“œ ì‹¤íŒ¨!"
    exit 1
fi
```

## ğŸ” ë³´ì•ˆ ë° ì¸ì¦ì„œ ê´€ë¦¬

### Jenkins Credentials ì„¤ì •
```groovy
// Jenkinsfile - ë³´ì•ˆ ì •ë³´ ì‚¬ìš©
withCredentials([
    file(credentialsId: 'android_keystore', variable: 'KEYSTORE_FILE'),
    string(credentialsId: 'ANDROID_KEYSTORE_PASSWORD', variable: 'STORE_PWD'),
    string(credentialsId: 'ANDROID_KEY_ALIAS', variable: 'KEY_ALIAS'),
    string(credentialsId: 'ANDROID_KEY_PASSWORD', variable: 'KEY_PWD')
]) {
    // í‚¤ìŠ¤í† ì–´ íŒŒì¼ ë³µì‚¬ ë° ì‚¬ìš©
    sh '''
        cp "$KEYSTORE_FILE" mobile/android/app/my-upload-key.keystore
        
        # local.properties ìƒì„±
        cat > mobile/android/local.properties << EOF
MYAPP_UPLOAD_STORE_PASSWORD=${STORE_PWD}
MYAPP_UPLOAD_KEY_PASSWORD=${KEY_PWD}
EOF
        
        # ë¹Œë“œ ì‹¤í–‰
        cd mobile/android
        ./gradlew assembleRelease
    '''
}
```

### í™˜ê²½ ë³€ìˆ˜ ì£¼ì…
```bash
# mobile/scripts/ci-make-env.sh - CI/CD í™˜ê²½ ë³€ìˆ˜ ìƒì„±
#!/bin/bash
set -euo pipefail

# í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜ í™•ì¸
if [ -z "${APP_ENV:-}" ] || [ -z "${API_BASE_URL:-}" ]; then
    echo "âŒ í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
    echo "í•„ìš”í•œ ë³€ìˆ˜: APP_ENV, API_BASE_URL"
    exit 1
fi

# í™˜ê²½ë³„ ê¸°ë³¸ê°’ ì„¤ì •
case "$APP_ENV" in
    "development")
        TIMEOUT="${TIMEOUT:-10000}"
        DEBUG_MODE="${DEBUG_MODE:-true}"
        LOG_LEVEL="${LOG_LEVEL:-debug}"
        ;;
    "staging")
        TIMEOUT="${TIMEOUT:-15000}"
        DEBUG_MODE="${DEBUG_MODE:-false}"
        LOG_LEVEL="${LOG_LEVEL:-info}"
        ;;
    "production")
        TIMEOUT="${TIMEOUT:-20000}"
        DEBUG_MODE="${DEBUG_MODE:-false}"
        LOG_LEVEL="${LOG_LEVEL:-warn}"
        ;;
esac

# .env íŒŒì¼ ìƒì„±
cat > .env.${APP_ENV} << EOF
APP_ENV=${APP_ENV}
API_BASE_URL=${API_BASE_URL}
TIMEOUT=${TIMEOUT}
DEBUG_MODE=${DEBUG_MODE}
LOG_LEVEL=${LOG_LEVEL}
BUILD_NUMBER=${BUILD_NUMBER:-dev}
BUILD_TIMESTAMP=$(date '+%Y%m%d-%H%M%S')
EOF

# í˜„ì¬ í™˜ê²½ íŒŒì¼ë¡œ ë³µì‚¬
cp .env.${APP_ENV} .env

echo "âœ… í™˜ê²½ ì„¤ì • íŒŒì¼ ìƒì„± ì™„ë£Œ: .env.${APP_ENV}"
```

## ğŸš€ ë°°í¬ ìë™í™”

### ì„œë²„ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸
```bash
# deploy.sh - ì„œë²„ ë°°í¬ ìë™í™”
#!/bin/bash
set -e

ENV=${1:-staging}
IMAGE_TAG=${2:-latest}

echo "ğŸš€ ${ENV} í™˜ê²½ ë°°í¬ ì‹œì‘..."

# í™˜ê²½ë³„ ì„¤ì • ë¡œë“œ
case "$ENV" in
    "staging")
        COMPOSE_FILE="docker-compose.staging.yml"
        ;;
    "production")
        COMPOSE_FILE="docker-compose.prod.yml"
        ;;
    *)
        echo "âŒ ì§€ì›í•˜ì§€ ì•ŠëŠ” í™˜ê²½: $ENV"
        exit 1
        ;;
esac

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
export BACKEND_IMAGE="object-monitor-backend:${IMAGE_TAG}"
export MYSQL_PASSWORD="${MYSQL_PASSWORD:-defaultpassword}"
export MYSQL_ROOT_PASSWORD="${MYSQL_ROOT_PASSWORD:-rootpassword}"
export MYSQL_DATABASE="${MYSQL_DATABASE:-object_monitor}"

# Docker ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
echo "ğŸ“¥ Docker ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ ì¤‘..."
docker-compose -f "$COMPOSE_FILE" pull backend

# ì„œë¹„ìŠ¤ ì¬ì‹œì‘
echo "ğŸ”„ ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì¤‘..."
docker-compose -f "$COMPOSE_FILE" up -d backend

# í—¬ìŠ¤ì²´í¬
echo "ğŸ¥ í—¬ìŠ¤ì²´í¬ ìˆ˜í–‰ ì¤‘..."
sleep 30

for i in {1..5}; do
    if curl -f http://localhost/api/health; then
        echo "âœ… ë°°í¬ ì™„ë£Œ ë° í—¬ìŠ¤ì²´í¬ ì„±ê³µ!"
        break
    else
        if [ $i -eq 5 ]; then
            echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨!"
            docker-compose -f "$COMPOSE_FILE" logs backend
            exit 1
        fi
        echo "â³ í—¬ìŠ¤ì²´í¬ ì¬ì‹œë„ ($i/5)..."
        sleep 10
    fi
done

echo "ğŸ‰ ${ENV} í™˜ê²½ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
```

## ğŸ“Š ëª¨ë‹ˆí„°ë§ ë° ë¡œê¹…

### ë¹Œë“œ ìƒíƒœ ëª¨ë‹ˆí„°ë§
```groovy
// Jenkinsfile - ë¹Œë“œ ê²°ê³¼ ì•Œë¦¼
post {
    success {
        script {
            def summary = """
ğŸ‰ ë¹Œë“œ ì„±ê³µ!
í™˜ê²½: ${params.APP_ENV}
ë¹Œë“œ: #${BUILD_NUMBER}
ì†Œìš”ì‹œê°„: ${currentBuild.durationString}
ì•„í‹°íŒ©íŠ¸: APK, iOS App, Docker Image
            """
            
            // Slack ì•Œë¦¼ (ì„ íƒì )
            if (env.SLACK_WEBHOOK_URL) {
                slackSend(
                    channel: '#ci-cd',
                    color: 'good',
                    message: summary
                )
            }
        }
    }
    
    failure {
        script {
            def failureMessage = """
ğŸ’¥ ë¹Œë“œ ì‹¤íŒ¨!
í™˜ê²½: ${params.APP_ENV}
ë¹Œë“œ: #${BUILD_NUMBER}
ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•´ì£¼ì„¸ìš”.
            """
            
            // ì‹¤íŒ¨ ì•Œë¦¼
            if (env.SLACK_WEBHOOK_URL) {
                slackSend(
                    channel: '#ci-cd',
                    color: 'danger',
                    message: failureMessage
                )
            }
        }
    }
    
    always {
        // ì•„í‹°íŒ©íŠ¸ ë³´ê´€
        archiveArtifacts artifacts: 'mobile/android/app/build/outputs/apk/release/*.apk', allowEmptyArchive: true
        archiveArtifacts artifacts: 'mobile/ios/build/Build/Products/Release-iphonesimulator/*.zip', allowEmptyArchive: true
        
        // ë¹Œë“œ ë¡œê·¸ ì •ë¦¬
        sh '''
            # ì„ì‹œ íŒŒì¼ ì •ë¦¬
            rm -f mobile/.env mobile/.env.*
            rm -f mobile/android/app/my-upload-key.keystore
            rm -f mobile/android/local.properties
            
            # Docker ì •ë¦¬
            docker system prune -f || true
        '''
    }
}
```

### ë°°í¬ ìƒíƒœ í™•ì¸
```bash
# ë°°í¬ í›„ ìƒíƒœ í™•ì¸ ìŠ¤í¬ë¦½íŠ¸
check_deployment_status() {
    local env=$1
    local max_attempts=10
    local attempt=1
    
    echo "ğŸ” ${env} í™˜ê²½ ë°°í¬ ìƒíƒœ í™•ì¸ ì¤‘..."
    
    while [ $attempt -le $max_attempts ]; do
        echo "ì‹œë„ $attempt/$max_attempts..."
        
        # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
        if docker-compose ps | grep -q "Up"; then
            echo "âœ… ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘"
            
            # API í—¬ìŠ¤ì²´í¬
            if curl -f http://localhost/api/health >/dev/null 2>&1; then
                echo "âœ… API í—¬ìŠ¤ì²´í¬ ì„±ê³µ"
                return 0
            else
                echo "âš ï¸ API ì‘ë‹µ ì—†ìŒ"
            fi
        else
            echo "âš ï¸ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ìƒíƒœ í™•ì¸ í•„ìš”"
        fi
        
        sleep 30
        ((attempt++))
    done
    
    echo "âŒ ë°°í¬ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨"
    return 1
}
```

## ğŸ”§ íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ê°€ì´ë“œ

### ì¼ë°˜ì ì¸ ë¹Œë“œ ì˜¤ë¥˜ í•´ê²°
```bash
# Android ë¹Œë“œ ì˜¤ë¥˜ í•´ê²°
fix_android_build_issues() {
    echo "ğŸ”§ Android ë¹Œë“œ ë¬¸ì œ í•´ê²° ì¤‘..."
    
    # Gradle ìºì‹œ ì •ë¦¬
    cd mobile/android
    ./gradlew clean
    ./gradlew cleanBuildCache
    
    # ì˜ì¡´ì„± ì¬ì„¤ì¹˜
    cd ..
    rm -rf node_modules
    yarn install
    
    # React Native ìºì‹œ ì •ë¦¬
    npx react-native start --reset-cache &
    sleep 5
    kill %1
    
    echo "âœ… Android ë¹Œë“œ í™˜ê²½ ì •ë¦¬ ì™„ë£Œ"
}

# iOS ë¹Œë“œ ì˜¤ë¥˜ í•´ê²°
fix_ios_build_issues() {
    echo "ğŸ”§ iOS ë¹Œë“œ ë¬¸ì œ í•´ê²° ì¤‘..."
    
    # iOS ë¹Œë“œ ìºì‹œ ì •ë¦¬
    rm -rf mobile/ios/build
    rm -rf mobile/ios/Pods
    
    # CocoaPods ì¬ì„¤ì¹˜
    cd mobile
    npx pod-install ios
    
    echo "âœ… iOS ë¹Œë“œ í™˜ê²½ ì •ë¦¬ ì™„ë£Œ"
}
```

### ë°°í¬ ë¡¤ë°± ì ˆì°¨
```bash
# ë°°í¬ ë¡¤ë°± ìŠ¤í¬ë¦½íŠ¸
rollback_deployment() {
    local env=$1
    local previous_tag=$2
    
    echo "ğŸ”„ ${env} í™˜ê²½ ë¡¤ë°± ì‹œì‘..."
    
    # ì´ì „ ì´ë¯¸ì§€ë¡œ ë¡¤ë°±
    export BACKEND_IMAGE="object-monitor-backend:${previous_tag}"
    docker-compose -f "docker-compose.${env}.yml" up -d backend
    
    # ë¡¤ë°± í™•ì¸
    sleep 30
    if curl -f http://localhost/api/health; then
        echo "âœ… ë¡¤ë°± ì™„ë£Œ"
    else
        echo "âŒ ë¡¤ë°± ì‹¤íŒ¨ - ìˆ˜ë™ í™•ì¸ í•„ìš”"
        exit 1
    fi
}
```