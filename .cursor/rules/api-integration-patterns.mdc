---
globs: mobile/src/services/**/*.ts,mobile/src/utils/axiosInstance.ts,mobile/src/types/api*.ts
description: API í†µì‹  ë° ë°ì´í„° ì²˜ë¦¬ íŒ¨í„´ ê°€ì´ë“œ
---

# API í†µì‹  ë° ë°ì´í„° ì²˜ë¦¬ íŒ¨í„´

## ğŸŒ API ì•„í‚¤í…ì²˜ ê°œìš”

### ë°±ì—”ë“œ API êµ¬ì¡°
ë°±ì—”ë“œëŠ” Flask ê¸°ë°˜ìœ¼ë¡œ ë‹¤ìŒê³¼ ê°™ì€ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì œê³µí•©ë‹ˆë‹¤:
- **ì¸ì¦**: `/api/auth/*` - ë¡œê·¸ì¸, íšŒì›ê°€ì…, í† í° ê°±ì‹ 
- **ê°ì²´ ê´€ë¦¬**: `/api/objects/*` - ëª¨ë‹ˆí„°ë§ ê°ì²´ CRUD
- **íƒì§€ ê²°ê³¼**: `/api/objects/{id}/detections` - AI íƒì§€ ê²°ê³¼
- **ì•Œë¦¼**: `/api/notifications/*` - ì‹¤ì‹œê°„ ì•Œë¦¼ ê´€ë¦¬

### API ì‘ë‹µ íŒ¨í„´
```typescript
// í‘œì¤€ API ì‘ë‹µ êµ¬ì¡° (mobile/src/types/api.ts ì°¸ì¡°)
interface ApiResponse<T = any> {
  success: boolean;
  data?: T;
  message?: string;
  error?: string;
}

// ëª©ë¡ ì¡°íšŒ ì‘ë‹µ (ë˜í•‘ëœ ë°ì´í„°)
GET /api/objects â†’ { success: true, data: ObjectItem[] }

// ë‹¨ì¼ ì¡°íšŒ ì‘ë‹µ (ì§ì ‘ ë°ì´í„°)
GET /api/objects/1 â†’ ObjectItem

// ì—ëŸ¬ ì‘ë‹µ
{ success: false, error: "ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤" }
```

## ğŸ”§ Axios ì¸ìŠ¤í„´ìŠ¤ ì„¤ì •

### ì¤‘ì•™í™”ëœ HTTP í´ë¼ì´ì–¸íŠ¸
ëª¨ë“  API í˜¸ì¶œì€ [mobile/src/utils/axiosInstance.ts](mdc:mobile/src/utils/axiosInstance.ts)ë¥¼ í†µí•´ ìˆ˜í–‰:

```typescript
import axios from 'axios';
import { getApiConfig } from '../config/apiConfig';

// í™˜ê²½ë³„ ì„¤ì • ì ìš©
const config = getApiConfig();

const axiosInstance = axios.create({
  baseURL: config.BASE_URL,
  timeout: config.TIMEOUT,
  headers: {
    'Content-Type': 'application/json',
  },
});

// ìš”ì²­ ì¸í„°ì…‰í„°: JWT í† í° ìë™ ì²¨ë¶€
axiosInstance.interceptors.request.use(async (config) => {
  if (!config.skipAuth) {
    const token = await getAccessToken();
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }
  }
  return config;
});

// ì‘ë‹µ ì¸í„°ì…‰í„°: í† í° ë§Œë£Œ ì‹œ ìë™ ê°±ì‹ 
axiosInstance.interceptors.response.use(
  (response) => response,
  async (error) => {
    if (error.response?.status === 401) {
      // í† í° ê°±ì‹  ë¡œì§
      const newToken = await refreshAccessToken();
      if (newToken) {
        // ì›ë˜ ìš”ì²­ ì¬ì‹œë„
        return axiosInstance.request(error.config);
      }
    }
    return Promise.reject(error);
  }
);
```

### í™˜ê²½ë³„ API ì„¤ì •
[mobile/src/config/apiConfig.ts](mdc:mobile/src/config/apiConfig.ts)ì—ì„œ í™˜ê²½ë³„ API ì„¤ì • ê´€ë¦¬:

```typescript
export const API_CONFIG = {
  DEVELOPMENT: {
    BASE_URL: 'http://192.168.1.169:5010',
    TIMEOUT: 10000,
  },
  STAGING: {
    BASE_URL: 'https://staging-api.your-domain.com',
    TIMEOUT: 15000,
  },
  PRODUCTION: {
    BASE_URL: 'https://api.your-domain.com',
    TIMEOUT: 15000,
  },
};
```

## ğŸ” ì¸ì¦ íŒ¨í„´

### JWT í† í° ê´€ë¦¬
```typescript
// authApi.ts - ì¸ì¦ ì„œë¹„ìŠ¤
export const authService = {
  // ë¡œê·¸ì¸: skipAuth ì˜µì…˜ìœ¼ë¡œ í† í° ì—†ì´ ìš”ì²­
  async login(loginData: LoginRequest): Promise<AuthResponse> {
    const response = await axiosInstance.post<AuthResponse>(
      API_ENDPOINTS.AUTH.LOGIN, 
      loginData,
      { skipAuth: true } // ë¡œê·¸ì¸ ì‹œì—ëŠ” í† í° ë¶ˆí•„ìš”
    );
    
    // í† í° ì €ì¥
    await storeTokens(response.data.access_token, response.data.refresh_token);
    return response.data;
  },

  // í† í° ê°±ì‹ : Authorization í—¤ë”ì— refresh token ì „ì†¡
  async refreshToken(): Promise<string> {
    const refreshToken = await getRefreshToken();
    const response = await axios.post(
      `${config.BASE_URL}/api/auth/refresh`,
      null, // bodyëŠ” null
      { headers: { Authorization: `Bearer ${refreshToken}` } }
    );
    return response.data.access_token;
  },
};
```

### í† í° ì €ì¥ì†Œ íŒ¨í„´
```typescript
// tokenStorage.ts - ì•ˆì „í•œ í† í° ì €ì¥
import AsyncStorage from '@react-native-async-storage/async-storage';

const TOKEN_KEYS = {
  ACCESS_TOKEN: 'access_token',
  REFRESH_TOKEN: 'refresh_token',
} as const;

export const storeTokens = async (accessToken: string, refreshToken: string) => {
  await Promise.all([
    AsyncStorage.setItem(TOKEN_KEYS.ACCESS_TOKEN, accessToken),
    AsyncStorage.setItem(TOKEN_KEYS.REFRESH_TOKEN, refreshToken),
  ]);
};

export const getAccessToken = async (): Promise<string | null> => {
  return AsyncStorage.getItem(TOKEN_KEYS.ACCESS_TOKEN);
};

export const clearTokens = async (): Promise<void> => {
  await AsyncStorage.multiRemove([TOKEN_KEYS.ACCESS_TOKEN, TOKEN_KEYS.REFRESH_TOKEN]);
};
```

## ğŸ“Š ë°ì´í„° ì²˜ë¦¬ íŒ¨í„´

### API ì„œë¹„ìŠ¤ êµ¬ì¡°í™”
ê° ë„ë©”ì¸ë³„ë¡œ API ì„œë¹„ìŠ¤ë¥¼ ë¶„ë¦¬:

```typescript
// objectApi.ts - ê°ì²´ ê´€ë¦¬ API
export const objectService = {
  // ëª©ë¡ ì¡°íšŒ (ë˜í•‘ëœ ì‘ë‹µ)
  async getObjects(): Promise<ObjectItem[]> {
    const response = await axiosInstance.get<ApiResponse<ObjectItem[]>>(
      API_ENDPOINTS.OBJECTS.LIST
    );
    return response.data.data || [];
  },

  // ë‹¨ì¼ ì¡°íšŒ (ì§ì ‘ ì‘ë‹µ)
  async getObject(id: number): Promise<ObjectItem> {
    const response = await axiosInstance.get<ObjectItem>(
      API_ENDPOINTS.OBJECTS.DETAIL(id)
    );
    return response.data;
  },

  // ìƒì„±
  async createObject(objectData: CreateObjectRequest): Promise<ObjectItem> {
    const response = await axiosInstance.post<ObjectItem>(
      API_ENDPOINTS.OBJECTS.CREATE,
      objectData
    );
    return response.data;
  },
};

// detectionApi.ts - íƒì§€ ê²°ê³¼ API
export const detectionService = {
  // ê°ì²´ë³„ íƒì§€ ê²°ê³¼ ì¡°íšŒ
  async getObjectDetections(objectId: number): Promise<DetectionResult[]> {
    const response = await axiosInstance.get<ApiResponse<DetectionResult[]>>(
      API_ENDPOINTS.DETECTIONS.LIST_BY_OBJECT(objectId)
    );
    return response.data.data || [];
  },

  // íƒì§€ ì‹¤í–‰
  async executeDetection(objectId: number): Promise<DetectionResult> {
    const response = await axiosInstance.post<DetectionResult>(
      API_ENDPOINTS.OBJECTS.DETECT(objectId)
    );
    return response.data;
  },
};
```

### ì—ëŸ¬ ì²˜ë¦¬ í‘œì¤€í™”
```typescript
// ì»´í¬ë„ŒíŠ¸ì—ì„œ API í˜¸ì¶œ ì‹œ í‘œì¤€ ì—ëŸ¬ ì²˜ë¦¬
const handleApiCall = async () => {
  try {
    setIsLoading(true);
    const result = await objectService.getObjects();
    setObjects(result);
  } catch (error: any) {
    // ì„œë²„ ì—ëŸ¬ ë©”ì‹œì§€ ìš°ì„  ì‚¬ìš©
    let errorMessage = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
    if (error.response?.data?.error) {
      errorMessage = error.response.data.error;
    } else if (error.response?.data?.detail) {
      errorMessage = error.response.data.detail;
    } else if (error.message) {
      errorMessage = error.message;
    }
    
    Alert.alert('ì˜¤ë¥˜', errorMessage);
    console.error('API í˜¸ì¶œ ì‹¤íŒ¨:', error);
  } finally {
    setIsLoading(false);
  }
};
```

## ğŸ”„ ì‹¤ì‹œê°„ ë°ì´í„° ì²˜ë¦¬

### í´ë§ íŒ¨í„´
```typescript
// ì£¼ê¸°ì  ë°ì´í„° ê°±ì‹ 
const usePolling = (apiCall: () => Promise<any>, interval: number = 5000) => {
  const [data, setData] = useState(null);
  
  useEffect(() => {
    const fetchData = async () => {
      try {
        const result = await apiCall();
        setData(result);
      } catch (error) {
        console.error('í´ë§ ì—ëŸ¬:', error);
      }
    };

    fetchData(); // ì´ˆê¸° ë¡œë“œ
    const intervalId = setInterval(fetchData, interval);
    
    return () => clearInterval(intervalId);
  }, [apiCall, interval]);

  return data;
};

// ì‚¬ìš© ì˜ˆì‹œ
const recentDetections = usePolling(() => detectionService.getRecentDetections(), 10000);
```

### ìºì‹œ ë° ìƒíƒœ ê´€ë¦¬
```typescript
// React Query íŒ¨í„´ (ì„ íƒì )
const useObjectsQuery = () => {
  return useQuery({
    queryKey: ['objects'],
    queryFn: objectService.getObjects,
    staleTime: 5 * 60 * 1000, // 5ë¶„ ìºì‹œ
    refetchOnWindowFocus: false,
  });
};
```

## ğŸ“± ì˜¤í”„ë¼ì¸ ì§€ì›

### ë„¤íŠ¸ì›Œí¬ ìƒíƒœ í™•ì¸
```typescript
import NetInfo from '@react-native-community/netinfo';

const useNetworkStatus = () => {
  const [isConnected, setIsConnected] = useState<boolean>(true);

  useEffect(() => {
    const unsubscribe = NetInfo.addEventListener(state => {
      setIsConnected(state.isConnected ?? false);
    });

    return unsubscribe;
  }, []);

  return isConnected;
};

// API í˜¸ì¶œ ì „ ë„¤íŠ¸ì›Œí¬ ìƒíƒœ í™•ì¸
const handleApiCallWithNetworkCheck = async () => {
  if (!isConnected) {
    Alert.alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜', 'ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  // API í˜¸ì¶œ ì§„í–‰
  await apiCall();
};
```

## ğŸ§ª API í…ŒìŠ¤íŠ¸ íŒ¨í„´

### Mock ë°ì´í„° í™œìš©
```typescript
// __mocks__/apiService.ts
export const mockObjectService = {
  getObjects: jest.fn().mockResolvedValue([
    { id: 1, name: 'í…ŒìŠ¤íŠ¸ ê°ì²´', status: 'active' }
  ]),
  
  createObject: jest.fn().mockResolvedValue(
    { id: 2, name: 'ìƒˆ ê°ì²´', status: 'active' }
  ),
};

// í…ŒìŠ¤íŠ¸ì—ì„œ ì‚¬ìš©
import { mockObjectService } from '../__mocks__/apiService';

describe('ObjectListScreen', () => {
  it('ê°ì²´ ëª©ë¡ì„ ì˜¬ë°”ë¥´ê²Œ í‘œì‹œí•´ì•¼ í•¨', async () => {
    const { getByText } = render(<ObjectListScreen />);
    
    await waitFor(() => {
      expect(getByText('í…ŒìŠ¤íŠ¸ ê°ì²´')).toBeTruthy();
    });
    
    expect(mockObjectService.getObjects).toHaveBeenCalledTimes(1);
  });
});
```