---
globs: back_end/**/*.py
description: Flask ë°±ì—”ë“œ ê°œë°œ íŒ¨í„´ ë° ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤
---

# Flask ë°±ì—”ë“œ ê°œë°œ íŒ¨í„´

## ğŸ—ï¸ ë°±ì—”ë“œ ì•„í‚¤í…ì²˜ ê°œìš”

### í”„ë¡œì íŠ¸ êµ¬ì¡°
- **ì§„ì…ì **: [back_end/app.py](mdc:back_end/app.py) - Flask ì•± ì´ˆê¸°í™” ë° ì‹¤í–‰
- **ì„¤ì •**: [back_end/config.py](mdc:back_end/config.py) - í™˜ê²½ë³„ ì„¤ì • ê´€ë¦¬
- **ëª¨ë¸**: [back_end/models.py](mdc:back_end/models.py) - SQLAlchemy ë°ì´í„°ë² ì´ìŠ¤ ëª¨ë¸
- **ë¼ìš°íŠ¸**: [back_end/routes.py](mdc:back_end/routes.py) - API ì—”ë“œí¬ì¸íŠ¸ ì •ì˜
- **AI ì„œë¹„ìŠ¤**: [back_end/detection_service.py](mdc:back_end/detection_service.py) - YOLOv8 ê°ì²´ íƒì§€

### ê¸°ìˆ  ìŠ¤íƒ
- **ì›¹ í”„ë ˆì„ì›Œí¬**: Flask + Flask-CORS + Flask-JWT-Extended
- **ë°ì´í„°ë² ì´ìŠ¤**: MySQL (ê°œë°œ: SQLite ëŒ€ì²´ ê°€ëŠ¥)
- **AI ëª¨ë¸**: YOLOv8 (Ultralytics)
- **ì´ë¯¸ì§€ ì²˜ë¦¬**: PIL, OpenCV
- **ë°°í¬**: Docker + Gunicorn

## ğŸ”§ Flask ì•± ì´ˆê¸°í™” íŒ¨í„´

### ì•± íŒ©í† ë¦¬ íŒ¨í„´
```python
# app.py - í‘œì¤€ Flask ì•± ì´ˆê¸°í™”
from flask import Flask
from flask_cors import CORS
from flask_jwt_extended import JWTManager
from config import config
from models import db

def create_app(config_name='development'):
    """Flask ì•± ìƒì„± ë° ì„¤ì •"""
    app = Flask(__name__)
    
    # í™˜ê²½ë³„ ì„¤ì • ë¡œë“œ
    app.config.from_object(config[config_name])
    
    # í™•ì¥ ê¸°ëŠ¥ ì´ˆê¸°í™”
    db.init_app(app)
    CORS(app, origins=["*"])  # ê°œë°œìš© - í”„ë¡œë•ì…˜ì—ì„œëŠ” ì œí•œ í•„ìš”
    
    jwt = JWTManager(app)
    
    # ë¸”ë£¨í”„ë¦°íŠ¸ ë“±ë¡
    from routes import auth_bp, objects_bp, logs_bp, notifications_bp
    app.register_blueprint(auth_bp, url_prefix='/api/auth')
    app.register_blueprint(objects_bp, url_prefix='/api/objects')
    app.register_blueprint(logs_bp, url_prefix='/api/logs')
    app.register_blueprint(notifications_bp, url_prefix='/api/notifications')
    
    return app

# ì•± ì‹¤í–‰
if __name__ == '__main__':
    app = create_app()
    with app.app_context():
        db.create_all()  # í…Œì´ë¸” ìƒì„±
        create_default_data()  # ê¸°ë³¸ ë°ì´í„° ìƒì„±
    
    app.run(host='0.0.0.0', port=5010, debug=True)
```

### í™˜ê²½ë³„ ì„¤ì • ê´€ë¦¬
```python
# config.py - í™˜ê²½ë³„ ì„¤ì • í´ë˜ìŠ¤
import os
from dotenv import load_dotenv

load_dotenv()

class Config:
    """ê¸°ë³¸ ì„¤ì •"""
    SECRET_KEY = os.getenv('SECRET_KEY', 'dev-secret-key')
    JWT_SECRET_KEY = os.getenv('JWT_SECRET_KEY', 'jwt-secret-key')
    JWT_ACCESS_TOKEN_EXPIRES = timedelta(hours=1)
    JWT_REFRESH_TOKEN_EXPIRES = timedelta(days=30)
    
    # ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •
    MYSQL_HOST = os.getenv('MYSQL_HOST', 'localhost')
    MYSQL_PORT = int(os.getenv('MYSQL_PORT', 3306))
    MYSQL_USER = os.getenv('MYSQL_USER', 'root')
    MYSQL_PASSWORD = os.getenv('MYSQL_PASSWORD', '')
    MYSQL_DATABASE = os.getenv('MYSQL_DATABASE', 'object_monitor')
    
    @property
    def SQLALCHEMY_DATABASE_URI(self):
        # MySQL ì—°ê²° ì‹¤íŒ¨ ì‹œ SQLite ëŒ€ì²´
        try:
            return f"mysql+pymysql://{self.MYSQL_USER}:{self.MYSQL_PASSWORD}@{self.MYSQL_HOST}:{self.MYSQL_PORT}/{self.MYSQL_DATABASE}"
        except:
            return 'sqlite:///fallback.db'

class DevelopmentConfig(Config):
    """ê°œë°œ í™˜ê²½ ì„¤ì •"""
    DEBUG = True
    SQLALCHEMY_ECHO = True  # SQL ì¿¼ë¦¬ ë¡œê¹…

class ProductionConfig(Config):
    """í”„ë¡œë•ì…˜ í™˜ê²½ ì„¤ì •"""
    DEBUG = False
    SQLALCHEMY_ECHO = False

config = {
    'development': DevelopmentConfig,
    'production': ProductionConfig,
    'default': DevelopmentConfig
}
```

## ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ëª¨ë¸ íŒ¨í„´

### SQLAlchemy ëª¨ë¸ ì •ì˜
```python
# models.py - ë°ì´í„°ë² ì´ìŠ¤ ëª¨ë¸
from flask_sqlalchemy import SQLAlchemy
from datetime import datetime
from werkzeug.security import generate_password_hash, check_password_hash

db = SQLAlchemy()

class User(db.Model):
    """ì‚¬ìš©ì ëª¨ë¸"""
    __tablename__ = 'users'
    
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(80), unique=True, nullable=False, index=True)
    email = db.Column(db.String(120), unique=True, nullable=False, index=True)
    password_hash = db.Column(db.String(255), nullable=False)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    
    # ê´€ê³„ ì„¤ì •
    objects = db.relationship('Object', backref='user', lazy=True, cascade='all, delete-orphan')
    
    def set_password(self, password):
        """ë¹„ë°€ë²ˆí˜¸ í•´ì‹œí™” ì €ì¥"""
        self.password_hash = generate_password_hash(password)
    
    def check_password(self, password):
        """ë¹„ë°€ë²ˆí˜¸ ê²€ì¦"""
        return check_password_hash(self.password_hash, password)
    
    def to_dict(self):
        """ë”•ì…”ë„ˆë¦¬ ë³€í™˜ (JSON ì‘ë‹µìš©)"""
        return {
            'id': self.id,
            'username': self.username,
            'email': self.email,
            'created_at': self.created_at.isoformat()
        }

class Object(db.Model):
    """ëª¨ë‹ˆí„°ë§ ê°ì²´ ëª¨ë¸"""
    __tablename__ = 'objects'
    
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100), nullable=False)
    description = db.Column(db.Text)
    status = db.Column(db.Enum('active', 'inactive'), default='active')
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    # ê´€ê³„ ì„¤ì •
    detections = db.relationship('Detection', backref='object', lazy=True, cascade='all, delete-orphan')
    
    def to_dict(self):
        return {
            'id': self.id,
            'name': self.name,
            'description': self.description,
            'status': self.status,
            'user_id': self.user_id,
            'created_at': self.created_at.isoformat(),
            'updated_at': self.updated_at.isoformat()
        }

class Detection(db.Model):
    """íƒì§€ ê²°ê³¼ ëª¨ë¸"""
    __tablename__ = 'detections'
    
    id = db.Column(db.Integer, primary_key=True)
    object_id = db.Column(db.Integer, db.ForeignKey('objects.id'), nullable=False)
    detection_type = db.Column(db.String(50), nullable=False)
    object_class = db.Column(db.String(50), nullable=False)
    confidence = db.Column(db.Float, nullable=False)
    
    # ë°”ìš´ë”© ë°•ìŠ¤ ì¢Œí‘œ
    bbox_x = db.Column(db.Integer)
    bbox_y = db.Column(db.Integer)
    bbox_width = db.Column(db.Integer)
    bbox_height = db.Column(db.Integer)
    
    danger_level = db.Column(db.Enum('safe', 'low', 'medium', 'high'), default='safe')
    image_path = db.Column(db.String(255))
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    
    def to_dict(self):
        return {
            'id': self.id,
            'object_id': self.object_id,
            'detection_type': self.detection_type,
            'object_class': self.object_class,
            'confidence': self.confidence,
            'bbox_x': self.bbox_x,
            'bbox_y': self.bbox_y,
            'bbox_width': self.bbox_width,
            'bbox_height': self.bbox_height,
            'danger_level': self.danger_level,
            'image_path': self.image_path,
            'created_at': self.created_at.isoformat()
        }
```

## ğŸ›£ï¸ API ë¼ìš°íŠ¸ íŒ¨í„´

### ë¸”ë£¨í”„ë¦°íŠ¸ êµ¬ì¡°í™”
```python
# routes.py - API ì—”ë“œí¬ì¸íŠ¸ ì •ì˜
from flask import Blueprint, request, jsonify
from flask_jwt_extended import jwt_required, create_access_token, get_jwt_identity
from models import db, User, Object, Detection

# ë¸”ë£¨í”„ë¦°íŠ¸ ìƒì„±
auth_bp = Blueprint('auth', __name__)
objects_bp = Blueprint('objects', __name__)

@auth_bp.route('/login', methods=['POST'])
def login():
    """ì‚¬ìš©ì ë¡œê·¸ì¸"""
    try:
        data = request.get_json()
        
        # ì…ë ¥ ê²€ì¦
        if not data or not data.get('username') or not data.get('password'):
            return jsonify({'error': 'ì‚¬ìš©ìëª…ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'}), 400
        
        # ì‚¬ìš©ì ì¡°íšŒ ë° ë¹„ë°€ë²ˆí˜¸ í™•ì¸
        user = User.query.filter_by(username=data['username']).first()
        if not user or not user.check_password(data['password']):
            return jsonify({'error': 'ì˜ëª»ëœ ì‚¬ìš©ìëª… ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤.'}), 401
        
        # JWT í† í° ìƒì„±
        access_token = create_access_token(identity=user.id)
        refresh_token = create_refresh_token(identity=user.id)
        
        return jsonify({
            'access_token': access_token,
            'refresh_token': refresh_token,
            'user': user.to_dict(),
            'message': 'ë¡œê·¸ì¸ ì„±ê³µ'
        }), 200
        
    except Exception as e:
        return jsonify({'error': f'ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}'}), 500

@objects_bp.route('', methods=['GET'])
@jwt_required()
def get_objects():
    """ì‚¬ìš©ìì˜ ê°ì²´ ëª©ë¡ ì¡°íšŒ"""
    try:
        user_id = get_jwt_identity()
        objects = Object.query.filter_by(user_id=user_id).all()
        
        return jsonify({
            'success': True,
            'data': [obj.to_dict() for obj in objects]
        }), 200
        
    except Exception as e:
        return jsonify({'error': f'ê°ì²´ ëª©ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}'}), 500

@objects_bp.route('/<int:object_id>', methods=['GET'])
@jwt_required()
def get_object(object_id):
    """íŠ¹ì • ê°ì²´ ìƒì„¸ ì¡°íšŒ"""
    try:
        user_id = get_jwt_identity()
        obj = Object.query.filter_by(id=object_id, user_id=user_id).first()
        
        if not obj:
            return jsonify({'error': 'ê°ì²´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'}), 404
        
        return jsonify(obj.to_dict()), 200
        
    except Exception as e:
        return jsonify({'error': f'ê°ì²´ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}'}), 500

@objects_bp.route('/<int:object_id>/detect', methods=['POST'])
@jwt_required()
def detect_object(object_id):
    """ê°ì²´ íƒì§€ ì‹¤í–‰"""
    try:
        user_id = get_jwt_identity()
        obj = Object.query.filter_by(id=object_id, user_id=user_id).first()
        
        if not obj:
            return jsonify({'error': 'ê°ì²´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'}), 404
        
        # AI íƒì§€ ì„œë¹„ìŠ¤ í˜¸ì¶œ
        from detection_service import run_detection
        detection_result = run_detection(object_id)
        
        return jsonify(detection_result.to_dict()), 200
        
    except Exception as e:
        return jsonify({'error': f'ê°ì²´ íƒì§€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}'}), 500
```

## ğŸ¤– AI ì„œë¹„ìŠ¤ íŒ¨í„´

### YOLOv8 í†µí•©
```python
# detection_service.py - AI ê°ì²´ íƒì§€ ì„œë¹„ìŠ¤
import os
from ultralytics import YOLO
from PIL import Image
import cv2
import numpy as np
from datetime import datetime
from models import db, Detection, Object

class DetectionService:
    def __init__(self):
        """YOLOv8 ëª¨ë¸ ì´ˆê¸°í™”"""
        self.model_path = 'yolov8n.pt'  # ëª¨ë¸ íŒŒì¼ ê²½ë¡œ
        self.model = None
        self.load_model()
    
    def load_model(self):
        """YOLO ëª¨ë¸ ë¡œë“œ"""
        try:
            if os.path.exists(self.model_path):
                self.model = YOLO(self.model_path)
                print(f"âœ… YOLO ëª¨ë¸ ë¡œë“œ ì™„ë£Œ: {self.model_path}")
            else:
                print(f"âŒ ëª¨ë¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {self.model_path}")
        except Exception as e:
            print(f"âŒ ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨: {str(e)}")
    
    def detect_objects(self, image_path: str, object_id: int) -> Detection:
        """ì´ë¯¸ì§€ì—ì„œ ê°ì²´ íƒì§€ ìˆ˜í–‰"""
        try:
            if not self.model:
                raise Exception("YOLO ëª¨ë¸ì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
            
            # ì´ë¯¸ì§€ ë¡œë“œ ë° ì „ì²˜ë¦¬
            image = cv2.imread(image_path)
            if image is None:
                raise Exception(f"ì´ë¯¸ì§€ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {image_path}")
            
            # YOLO ì¶”ë¡  ì‹¤í–‰
            results = self.model(image)
            
            # ê²°ê³¼ ì²˜ë¦¬
            detections = []
            for result in results:
                boxes = result.boxes
                if boxes is not None:
                    for box in boxes:
                        # ë°”ìš´ë”© ë°•ìŠ¤ ì¢Œí‘œ
                        x1, y1, x2, y2 = box.xyxy[0].cpu().numpy()
                        confidence = float(box.conf[0].cpu().numpy())
                        class_id = int(box.cls[0].cpu().numpy())
                        class_name = self.model.names[class_id]
                        
                        # ìœ„í—˜ë„ ê³„ì‚°
                        danger_level = self.calculate_danger_level(class_name, confidence)
                        
                        # íƒì§€ ê²°ê³¼ ì €ì¥
                        detection = Detection(
                            object_id=object_id,
                            detection_type='yolo_detection',
                            object_class=class_name,
                            confidence=confidence,
                            bbox_x=int(x1),
                            bbox_y=int(y1),
                            bbox_width=int(x2 - x1),
                            bbox_height=int(y2 - y1),
                            danger_level=danger_level,
                            image_path=image_path
                        )
                        
                        db.session.add(detection)
                        detections.append(detection)
            
            db.session.commit()
            
            # ê°€ì¥ ë†’ì€ ì‹ ë¢°ë„ì˜ íƒì§€ ê²°ê³¼ ë°˜í™˜
            if detections:
                return max(detections, key=lambda d: d.confidence)
            else:
                # íƒì§€ëœ ê°ì²´ê°€ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ ê²°ê³¼ ìƒì„±
                return self.create_no_detection_result(object_id, image_path)
                
        except Exception as e:
            db.session.rollback()
            raise Exception(f"ê°ì²´ íƒì§€ ì‹¤íŒ¨: {str(e)}")
    
    def calculate_danger_level(self, class_name: str, confidence: float) -> str:
        """ê°ì²´ í´ë˜ìŠ¤ì™€ ì‹ ë¢°ë„ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìœ„í—˜ë„ ê³„ì‚°"""
        # ìœ„í—˜í•œ ê°ì²´ í´ë˜ìŠ¤ ì •ì˜
        dangerous_classes = ['knife', 'gun', 'fire', 'person']
        
        if class_name in dangerous_classes:
            if confidence > 0.8:
                return 'high'
            elif confidence > 0.6:
                return 'medium'
            else:
                return 'low'
        else:
            return 'safe'
    
    def create_no_detection_result(self, object_id: int, image_path: str) -> Detection:
        """íƒì§€ëœ ê°ì²´ê°€ ì—†ì„ ë•Œ ê¸°ë³¸ ê²°ê³¼ ìƒì„±"""
        detection = Detection(
            object_id=object_id,
            detection_type='no_detection',
            object_class='none',
            confidence=0.0,
            danger_level='safe',
            image_path=image_path
        )
        
        db.session.add(detection)
        db.session.commit()
        return detection

# ì „ì—­ ì„œë¹„ìŠ¤ ì¸ìŠ¤í„´ìŠ¤
detection_service = DetectionService()

def run_detection(object_id: int) -> Detection:
    """ê°ì²´ íƒì§€ ì‹¤í–‰ (ë¼ìš°íŠ¸ì—ì„œ í˜¸ì¶œ)"""
    # ì„ì‹œ ì´ë¯¸ì§€ ìƒì„± ë˜ëŠ” ê¸°ì¡´ ì´ë¯¸ì§€ ì‚¬ìš©
    image_path = f"uploads/detections/{object_id}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.jpg"
    
    # ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ì¹´ë©”ë¼ë‚˜ ì—…ë¡œë“œëœ ì´ë¯¸ì§€ ì‚¬ìš©
    # ì—¬ê¸°ì„œëŠ” ë°ëª¨ìš© ë”ë¯¸ ì´ë¯¸ì§€ ìƒì„±
    create_dummy_image(image_path)
    
    return detection_service.detect_objects(image_path, object_id)

def create_dummy_image(image_path: str):
    """ë°ëª¨ìš© ë”ë¯¸ ì´ë¯¸ì§€ ìƒì„±"""
    os.makedirs(os.path.dirname(image_path), exist_ok=True)
    
    # 640x480 í¬ê¸°ì˜ ë”ë¯¸ ì´ë¯¸ì§€ ìƒì„±
    dummy_image = np.random.randint(0, 255, (480, 640, 3), dtype=np.uint8)
    cv2.imwrite(image_path, dummy_image)
```

## ğŸ”’ ë³´ì•ˆ ë° ì—ëŸ¬ ì²˜ë¦¬

### JWT í† í° ê´€ë¦¬
```python
# JWT ì„¤ì • ë° ì—ëŸ¬ í•¸ë“¤ëŸ¬
from flask_jwt_extended import JWTManager

jwt = JWTManager(app)

@jwt.expired_token_loader
def expired_token_callback(jwt_header, jwt_payload):
    """ë§Œë£Œëœ í† í° ì²˜ë¦¬"""
    return jsonify({'error': 'í† í°ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.'}), 401

@jwt.invalid_token_loader
def invalid_token_callback(error):
    """ìœ íš¨í•˜ì§€ ì•Šì€ í† í° ì²˜ë¦¬"""
    return jsonify({'error': 'ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì…ë‹ˆë‹¤.'}), 401

@jwt.unauthorized_loader
def missing_token_callback(error):
    """í† í° ëˆ„ë½ ì²˜ë¦¬"""
    return jsonify({'error': 'ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.'}), 401
```

### ì „ì—­ ì—ëŸ¬ í•¸ë“¤ëŸ¬
```python
# ì „ì—­ ì—ëŸ¬ ì²˜ë¦¬
@app.errorhandler(404)
def not_found(error):
    return jsonify({'error': 'ìš”ì²­í•œ ë¦¬ì†ŒìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'}), 404

@app.errorhandler(500)
def internal_error(error):
    db.session.rollback()
    return jsonify({'error': 'ì„œë²„ ë‚´ë¶€ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}), 500

@app.errorhandler(Exception)
def handle_exception(e):
    """ëª¨ë“  ì˜ˆì™¸ ì²˜ë¦¬"""
    db.session.rollback()
    app.logger.error(f'ì˜ˆì™¸ ë°œìƒ: {str(e)}')
    return jsonify({'error': 'ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}), 500
```

## ğŸ³ Docker ë°°í¬ íŒ¨í„´

### Dockerfile ìµœì í™”
```dockerfile
# Dockerfile - ë©€í‹°ìŠ¤í…Œì´ì§€ ë¹Œë“œ
FROM python:3.12-slim as builder

# ì‹œìŠ¤í…œ ì˜ì¡´ì„± ì„¤ì¹˜
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    libgl1-mesa-glx \
    libglib2.0-0 \
    && rm -rf /var/lib/apt/lists/*

# Python ì˜ì¡´ì„± ì„¤ì¹˜
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# í”„ë¡œë•ì…˜ ìŠ¤í…Œì´ì§€
FROM python:3.12-slim

# ëŸ°íƒ€ì„ ì˜ì¡´ì„±ë§Œ ì„¤ì¹˜
RUN apt-get update && apt-get install -y \
    libgl1-mesa-glx \
    libglib2.0-0 \
    && rm -rf /var/lib/apt/lists/*

# ë¹Œë“œ ìŠ¤í…Œì´ì§€ì—ì„œ íŒ¨í‚¤ì§€ ë³µì‚¬
COPY --from=builder /usr/local/lib/python3.12/site-packages /usr/local/lib/python3.12/site-packages
COPY --from=builder /usr/local/bin /usr/local/bin

# ì•± ì½”ë“œ ë³µì‚¬
WORKDIR /app
COPY . .

# ê¶Œí•œ ì„¤ì •
RUN chmod +x app.py

# í¬íŠ¸ ë…¸ì¶œ
EXPOSE 5010

# Gunicornìœ¼ë¡œ ì‹¤í–‰
CMD ["gunicorn", "--bind", "0.0.0.0:5010", "--workers", "4", "app:app"]
```